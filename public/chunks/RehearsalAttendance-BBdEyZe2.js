import{u as B,j as e}from"../assets/index-CoKafZFz.js";import{r as c}from"./vendor-C9PcmKF2.js";import{a as m}from"./cascade-deletion-BvQll6O-.js";import{a as J,c as U,a1 as W,h as X,M as q,e as L,f as z,J as G,S as H,g as K,d as Q,k as V}from"./ui-DsxFGtGk.js";import"./query-BdHdBeoH.js";import"./utils-x1PSU_OZ.js";function re({rehearsalId:g,orchestraId:f}){B();const[r,k]=c.useState(null),[o,y]=c.useState([]),[M,v]=c.useState(!0),[C,S]=c.useState(!1),[x,A]=c.useState(""),[j,D]=c.useState("all"),[T,h]=c.useState(null);c.useEffect(()=>{g?p():f&&R()},[g,f]);const p=async()=>{if(g)try{v(!0),h(null);const[t,s]=await Promise.all([m.rehearsals.getRehearsal(g),m.rehearsals.getAttendance(g)]),i=await m.orchestras.getOrchestra(t.groupId);k({id:t._id,orchestraId:t.groupId,orchestraName:i.name,date:new Date(t.scheduledDate).toLocaleDateString("he-IL"),startTime:t.startTime||"19:00",endTime:t.endTime||"21:00",location:t.location||"אולם מוזיקה",duration:t.duration||120,status:t.status||"scheduled"});const u=i.memberDetails||[],d=new Map;s&&s.attendanceList&&s.attendanceList.forEach(a=>{d.set(a.studentId,{status:a.status,arrivalTime:a.arrivalTime,notes:a.notes})});const l=u.map(a=>{const w=d.get(a._id);return{id:a._id,name:a.personalInfo?.fullName||`${a.personalInfo?.firstName} ${a.personalInfo?.lastName}`,instrument:a.academicInfo?.instrumentProgress?.find(O=>O.isPrimary)?.instrumentName||"",section:a.section||"כללי",status:w?.status||"not_marked",arrivalTime:w?.arrivalTime,notes:w?.notes}});y(l)}catch(t){console.error("Error loading rehearsal attendance:",t),h("שגיאה בטעינת נתוני נוכחות")}finally{v(!1)}},R=async()=>{if(f)try{v(!0),h(null);const t=new Date().toISOString().split("T")[0],s=await m.rehearsals.getRehearsals({groupId:f,date:t});if(s.length===0){h("אין חזרה מתוכננת היום לתזמורת זו");return}const i=s[0];await p()}catch(t){console.error("Error loading current rehearsal:",t),h("שגיאה בטעינת חזרה נוכחית")}finally{v(!1)}},N=(t,s,i)=>{y(u=>u.map(d=>d.id===t?{...d,status:s,arrivalTime:s==="present"||s==="late"?new Date().toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"}):void 0,notes:i}:d))},E=async()=>{if(r)try{S(!0);const t={rehearsalId:r.id,attendanceList:o.filter(s=>s.status!=="not_marked").map(s=>({studentId:s.id,status:s.status,arrivalTime:s.arrivalTime,notes:s.notes||""}))};await m.rehearsals.updateAttendance(r.id,t),alert("נוכחות נשמרה בהצלחה")}catch(t){console.error("Error saving attendance:",t),alert("שגיאה בשמירת הנוכחות")}finally{S(!1)}},I=()=>{y(t=>t.map(s=>({...s,status:"present",arrivalTime:new Date().toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"})})))},$=()=>o.filter(t=>{const s=x===""||t.name.toLowerCase().includes(x.toLowerCase())||t.instrument.toLowerCase().includes(x.toLowerCase())||t.section.toLowerCase().includes(x.toLowerCase()),i=j==="all"||t.status===j;return s&&i}),_=()=>{const t=o.length,s=o.filter(l=>l.status==="present").length,i=o.filter(l=>l.status==="absent").length,u=o.filter(l=>l.status==="late").length,d=o.filter(l=>l.status==="not_marked").length;return{total:t,present:s,absent:i,late:u,notMarked:d}},P=t=>{switch(t){case"present":return"text-green-600 bg-green-100";case"absent":return"text-red-600 bg-red-100";case"late":return"text-yellow-600 bg-yellow-100";default:return"text-gray-600 bg-gray-100"}},F=t=>{switch(t){case"present":return"נוכח";case"absent":return"נעדר";case"late":return"מאחר";default:return"לא סומן"}};if(M)return e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600 font-reisinger-yonatan",children:"טוען נתוני נוכחות..."})]})});if(T)return e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center gap-2 text-red-800",children:[e.jsx(J,{className:"w-5 h-5"}),e.jsx("div",{className:"font-reisinger-yonatan",children:T})]})});if(!r)return e.jsxs("div",{className:"text-center py-12",children:[e.jsx(U,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600 font-reisinger-yonatan",children:"לא נמצאה חזרה"})]});const n=_(),b=$();return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 font-reisinger-yonatan",children:"נוכחות חזרה"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:p,className:"flex items-center gap-2 px-3 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg hover:bg-gray-50",children:[e.jsx(W,{className:"w-4 h-4"}),"רענן"]}),e.jsxs("button",{onClick:E,disabled:C,className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50",children:[e.jsx(X,{className:"w-4 h-4"}),C?"שומר...":"שמור נוכחות"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(q,{className:"w-5 h-5 text-indigo-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 font-reisinger-yonatan",children:r.orchestraName}),e.jsx("div",{className:"text-sm text-gray-600",children:r.date})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(L,{className:"w-5 h-5 text-indigo-600"}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium text-gray-900",children:[r.startTime," - ",r.endTime]}),e.jsxs("div",{className:"text-sm text-gray-600",children:[r.duration," דקות"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(z,{className:"w-5 h-5 text-indigo-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:r.location}),e.jsx("div",{className:"text-sm text-gray-600",children:"מקום החזרה"})]})]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 font-reisinger-yonatan",children:"סיכום נוכחות"}),e.jsx("button",{onClick:I,className:"text-sm text-indigo-600 hover:text-indigo-700 font-medium",children:"סמן הכל כנוכח"})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:n.total}),e.jsx("div",{className:"text-sm text-gray-600 font-reisinger-yonatan",children:"סה״כ חברים"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:n.present}),e.jsx("div",{className:"text-sm text-gray-600 font-reisinger-yonatan",children:"נוכחים"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:n.absent}),e.jsx("div",{className:"text-sm text-gray-600 font-reisinger-yonatan",children:"נעדרים"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:n.late}),e.jsx("div",{className:"text-sm text-gray-600 font-reisinger-yonatan",children:"מאחרים"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-gray-500",children:n.notMarked}),e.jsx("div",{className:"text-sm text-gray-600 font-reisinger-yonatan",children:"לא סומנו"})]})]}),n.total>0&&e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600 mb-2",children:[e.jsx(G,{className:"w-4 h-4"}),e.jsxs("span",{children:["אחוז נוכחות: ",Math.round(n.present/n.total*100),"%"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-green-600 h-2 rounded-full transition-all duration-300",style:{width:`${n.present/n.total*100}%`}})})]})]}),e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(H,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",placeholder:"חיפוש לפי שם, כלי או קבוצה...",value:x,onChange:t=>A(t.target.value),className:"w-full pl-4 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",dir:"rtl"})]}),e.jsxs("select",{value:j,onChange:t=>D(t.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500",children:[e.jsx("option",{value:"all",children:"כל הסטטוסים"}),e.jsx("option",{value:"present",children:"נוכחים"}),e.jsx("option",{value:"absent",children:"נעדרים"}),e.jsx("option",{value:"late",children:"מאחרים"}),e.jsx("option",{value:"not_marked",children:"לא סומנו"})]})]})}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200",children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 font-reisinger-yonatan",children:["רשימת חברים (",b.length,")"]})}),b.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(K,{className:"w-12 h-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 font-reisinger-yonatan",children:x||j!=="all"?"לא נמצאו חברים":"אין חברים רשומים"})]}):e.jsx("div",{className:"divide-y divide-gray-200",children:b.map(t=>e.jsx("div",{className:"p-4 hover:bg-gray-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${t.status==="present"?"bg-green-500":t.status==="absent"?"bg-red-500":t.status==="late"?"bg-yellow-500":"bg-gray-400"}`}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 font-reisinger-yonatan",children:t.name}),e.jsxs("div",{className:"text-sm text-gray-600",children:[t.instrument," • ",t.section,t.arrivalTime&&e.jsxs("span",{className:"mr-2",children:["• הגיע ב-",t.arrivalTime]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${P(t.status)}`,children:F(t.status)}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:()=>N(t.id,"present"),className:`p-1.5 rounded transition-colors ${t.status==="present"?"bg-green-100 text-green-600":"text-gray-400 hover:text-green-600 hover:bg-green-50"}`,title:"נוכח",children:e.jsx(Q,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>N(t.id,"late"),className:`p-1.5 rounded transition-colors ${t.status==="late"?"bg-yellow-100 text-yellow-600":"text-gray-400 hover:text-yellow-600 hover:bg-yellow-50"}`,title:"מאחר",children:e.jsx(L,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>N(t.id,"absent"),className:`p-1.5 rounded transition-colors ${t.status==="absent"?"bg-red-100 text-red-600":"text-gray-400 hover:text-red-600 hover:bg-red-50"}`,title:"נעדר",children:e.jsx(V,{className:"w-4 h-4"})})]})]})]})},t.id))})]})]})}export{re as default};
