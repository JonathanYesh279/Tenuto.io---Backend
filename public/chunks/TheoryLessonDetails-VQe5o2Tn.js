import{j as e,T as ue,C as ye}from"../assets/index-CoKafZFz.js";import{c as fe,b as be,r}from"./vendor-C9PcmKF2.js";import{C as $}from"./Card-1BAWwzNR.js";import{T as U}from"./Table-AhthNN5h.js";import{S as v}from"./StatsCard-DEtP3a5j.js";import{d as g,f as je,t as pe}from"./cascade-deletion-BvQll6O-.js";import{B as I,ae as V,u as A,O as Ne,T as ve,g as _,X as E,c as we,U as Ce,e as Se,f as ke,P as W,S as Te,q as Ie}from"./ui-DsxFGtGk.js";import"./query-BdHdBeoH.js";import"./utils-x1PSU_OZ.js";const q={0:"ראשון",1:"שני",2:"שלישי",3:"רביעי",4:"חמישי",5:"שישי",6:"שבת"};function Me(){const{theoryId:n}=fe(),u=be(),[t,B]=r.useState(null),[d,Q]=r.useState([]),[L,z]=r.useState([]),[K,P]=r.useState(!0),[j,m]=r.useState(null),[X,w]=r.useState(!1),[D,C]=r.useState(!1);r.useState(!1);const[Y,p]=r.useState(!1),[N,R]=r.useState(""),[G,H]=r.useState(new Date().toISOString().split("T")[0]),[S,y]=r.useState({present:[],absent:[]}),[J,k]=r.useState(!1),[x,T]=r.useState(null),O=s=>{T(s),k(!0)},Z=()=>{x?.onConfirm&&x.onConfirm(),k(!1),T(null)},ee=()=>{k(!1),T(null)};r.useEffect(()=>{n&&f()},[n]);const f=async()=>{if(n)try{P(!0),m(null);const[s,a,l]=await Promise.all([g.getTheoryLesson(n),je.getStudents(),pe.getTeachers()]);B(s),Q(a),z(l),y(s.attendance||{present:[],absent:[]})}catch(s){console.error("Error loading theory lesson details:",s),m("שגיאה בטעינת פרטי שיעור התאוריה")}finally{P(!1)}},se=async s=>{if(n)try{await g.updateTheoryLesson(n,s),w(!1),await f()}catch(a){throw console.error("Error updating theory lesson:",a),a}},te=async s=>{if(n)try{await g.addStudentToTheory(n,s),await f()}catch(a){console.error("Error adding student:",a),m("שגיאה בהוספת תלמיד לשיעור")}},ae=s=>{n&&O({title:"הסרת תלמיד מהשיעור",message:"האם אתה בטוח שברצונך להסיר את התלמיד מהשיעור?",variant:"danger",onConfirm:async()=>{try{await g.removeStudentFromTheory(n,s),await f()}catch(a){console.error("Error removing student:",a),m("שגיאה בהסרת תלמיד מהשיעור")}}})},re=()=>{n&&O({title:"מחיקת שיעור תאוריה",message:"האם אתה בטוח שברצונך למחוק את שיעור התאוריה? פעולה זו אינה הפיכה.",variant:"danger",onConfirm:async()=>{try{await g.deleteTheoryLesson(n),u("/theories")}catch(s){console.error("Error deleting theory lesson:",s),m("שגיאה במחיקת שיעור התאוריה")}}})},ne=async()=>{if(n)try{await g.updateTheoryAttendance(n,S),await f(),p(!1)}catch(s){console.error("Error updating attendance:",s),m("שגיאה בעדכון נוכחות")}},F=(s,a)=>{y(l=>{const i={present:[...l.present],absent:[...l.absent]};return a?(i.present=[...i.present.filter(c=>c!==s),s],i.absent=i.absent.filter(c=>c!==s)):(i.absent=[...i.absent.filter(c=>c!==s),s],i.present=i.present.filter(c=>c!==s)),i})},le=r.useCallback(()=>{if(!t)return;const s=d.filter(a=>t.studentIds.includes(a._id)).map(a=>a._id);y({present:s,absent:[]})},[t,d]),ie=r.useCallback(()=>{if(!t)return;const s=d.filter(a=>t.studentIds.includes(a._id)).map(a=>a._id);y({present:[],absent:s})},[t,d]),oe=r.useCallback(()=>{y({present:[],absent:[]})},[]),ce=s=>{u(`/students/${s}`)},de=s=>{u(`/teachers/${s}`)},me=r.useMemo(()=>!!t,[t]);if(K)return e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-4"}),e.jsx("div",{className:"text-gray-600",children:"טוען פרטי שיעור תאוריה..."})]})});if(j||!t)return e.jsxs("div",{className:"text-center py-12",children:[e.jsx(I,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"שגיאה בטעינת שיעור התאוריה"}),e.jsx("p",{className:"text-gray-600 mb-4",children:j||"שיעור תאוריה לא נמצא"}),e.jsxs("button",{onClick:()=>u("/theories"),className:"inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors",children:[e.jsx(V,{className:"w-4 h-4 ml-2"}),"חזור לרשימת שיעורי תאוריה"]})]});const M=d.filter(s=>!t.studentIds.includes(s._id)&&s.isActive&&(!N||s.personalInfo?.fullName?.toLowerCase().includes(N.toLowerCase())||s.academicInfo?.class?.includes(N))),o=d.filter(s=>t.studentIds.includes(s._id)),b=L.find(s=>s._id===t.teacherId),h={totalStudents:o.length,attendanceRate:t.attendance&&o.length>0?t.attendance.present.length/o.length*100:0,presentCount:t.attendance?.present.length||0,absentCount:t.attendance?.absent.length||0},xe=s=>isNaN(s)?"red":s>=75?"green":s>=50?"orange":"red",he=[{key:"name",label:"שם",render:s=>e.jsx("div",{className:"flex items-center",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:s.personalInfo?.fullName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["כיתה ",s.academicInfo?.class]})]})})},{key:"instrument",label:"כלי ראשי",render:s=>{const a=s.academicInfo?.instrumentProgress?.find(l=>l.isPrimary);return a?e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:a.instrumentName}),e.jsxs("span",{className:"text-sm text-gray-500 block",children:["שלב ",a.currentStage]})]}):"לא צוין"}},{key:"contact",label:"פרטי קשר",render:s=>e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("div",{children:s.personalInfo?.phone}),s.personalInfo?.studentEmail&&e.jsx("div",{className:"text-xs",children:s.personalInfo.studentEmail})]})}],ge=[{key:"name",label:"שם",render:s=>e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:s.personalInfo?.fullName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["כיתה ",s.academicInfo?.class]})]})},{key:"instrument",label:"כלי ראשי",render:s=>s.academicInfo?.instrumentProgress?.find(l=>l.isPrimary)?.instrumentName||"לא צוין"},{key:"actions",label:"פעולות",render:s=>e.jsxs("button",{onClick:()=>te(s._id),className:"inline-flex items-center px-2 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors",children:[e.jsx(Ie,{className:"w-3 h-3 ml-1"}),"הוסף"]})}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:()=>u("/theories"),className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(V,{className:"w-5 h-5 text-gray-600"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(I,{className:"w-6 h-6 text-primary-600"}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:t.category}),e.jsx("span",{className:"text-xs font-medium px-2 py-1 rounded-full bg-gray-100 text-gray-700",children:q[t.dayOfWeek]}),e.jsxs("span",{className:"text-xs font-medium px-2 py-1 rounded-full bg-primary-100 text-primary-700",children:[t.startTime," - ",t.endTime]})]}),e.jsx("p",{className:"text-gray-600",children:"ניהול תלמידים, נוכחות וחומרי לימוד"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[me&&e.jsxs("button",{onClick:()=>p(!0),className:"flex items-center px-3 py-2 text-green-700 border border-green-300 rounded-lg hover:bg-green-50 transition-colors",children:[e.jsx(A,{className:"w-4 h-4 ml-1"}),"נוכחות"]}),e.jsxs("button",{onClick:()=>w(!0),className:"flex items-center px-3 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors",children:[e.jsx(Ne,{className:"w-4 h-4 ml-1"}),"ערוך"]}),e.jsxs("button",{onClick:re,className:"flex items-center px-3 py-2 text-red-700 border border-red-300 rounded-lg hover:bg-red-50 transition-colors",children:[e.jsx(ve,{className:"w-4 h-4 ml-1"}),"מחק"]})]})]}),j&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("p",{className:"text-red-800",children:j})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsx(v,{title:"תלמידים רשומים",value:h.totalStudents.toString(),subtitle:"תלמידים בשיעור",icon:e.jsx(_,{}),color:"blue"}),e.jsx(v,{title:"נוכחים",value:h.presentCount.toString(),subtitle:"בשיעור האחרון",icon:e.jsx(A,{}),color:"green"}),e.jsx(v,{title:"נעדרים",value:h.absentCount.toString(),subtitle:"בשיעור האחרון",icon:e.jsx(E,{}),color:"red"}),e.jsx(v,{title:"אחוז נוכחות",value:`${isNaN(h.attendanceRate)?0:Math.round(h.attendanceRate)}%`,subtitle:"ממוצע כללי",icon:e.jsx(we,{}),color:xe(h.attendanceRate)})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsxs($,{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"פרטי השיעור"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start",children:[e.jsx(Ce,{className:"w-5 h-5 text-gray-400 mt-0.5 ml-3"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:"מורה"}),b?e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("button",{onClick:()=>de(b._id),className:"text-primary-600 hover:text-primary-700 hover:underline",children:b.personalInfo?.fullName}),b.personalInfo?.email&&e.jsx("div",{className:"text-xs text-gray-500",children:b.personalInfo.email})]}):e.jsx("div",{className:"text-sm text-gray-500",children:"לא הוקצה מורה"})]})]}),e.jsxs("div",{className:"flex items-start",children:[e.jsx(Se,{className:"w-5 h-5 text-gray-400 mt-0.5 ml-3"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:"זמן"}),e.jsxs("div",{className:"text-sm text-gray-600",children:[q[t.dayOfWeek]," ",t.startTime," - ",t.endTime]}),e.jsx("div",{className:"text-xs text-gray-500",children:new Date(t.date).toLocaleDateString("he-IL")})]})]}),e.jsxs("div",{className:"flex items-start",children:[e.jsx(ke,{className:"w-5 h-5 text-gray-400 mt-0.5 ml-3"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:"מיקום"}),e.jsx("div",{className:"text-sm text-gray-600",children:t.location})]})]}),e.jsxs("div",{className:"flex items-start",children:[e.jsx(I,{className:"w-5 h-5 text-gray-400 mt-0.5 ml-3"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:"קטגוריה"}),e.jsx("div",{className:"text-sm text-gray-600",children:t.category})]})]})]}),(t.notes||t.syllabus||t.homework)&&e.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-100",children:[e.jsx("h4",{className:"font-medium text-gray-900 mb-3",children:"מידע נוסף"}),t.syllabus&&e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"text-xs font-medium text-black font-semibold mb-1",style:{color:"#000000"},children:"סילבוס:"}),e.jsx("div",{className:"text-sm text-gray-600 p-2 bg-gray-50 rounded",children:t.syllabus})]}),t.homework&&e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"text-xs font-medium text-black font-semibold mb-1",style:{color:"#000000"},children:"שיעורי בית:"}),e.jsx("div",{className:"text-sm text-gray-600 p-2 bg-gray-50 rounded",children:t.homework})]}),t.notes&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-black font-semibold mb-1",style:{color:"#000000"},children:"הערות:"}),e.jsx("div",{className:"text-sm text-gray-600 p-2 bg-gray-50 rounded",children:t.notes})]})]})]})}),e.jsx("div",{className:"lg:col-span-2",children:e.jsxs($,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900",children:["תלמידים רשומים (",o.length,")"]}),e.jsxs("button",{onClick:()=>C(!D),className:"flex items-center px-3 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors",children:[e.jsx(W,{className:"w-4 h-4 ml-1"}),"הוסף תלמיד"]})]}),D&&e.jsxs("div",{className:"mb-6 p-4 bg-gray-50 rounded-lg border",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(Te,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"חיפוש תלמידים...",value:N,onChange:s=>R(s.target.value),className:"w-full pr-10 pl-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"})]})}),e.jsx("button",{onClick:()=>{C(!1),R("")},className:"px-3 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-100",children:"ביטול"})]}),M.length>0?e.jsx("div",{className:"max-h-64 overflow-y-auto",children:e.jsx(U,{data:M,columns:ge,actions:!1})}):e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(_,{className:"w-8 h-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{children:"אין תלמידים זמינים להוספה"})]})]}),o.length>0?e.jsx(U,{data:o,columns:he,onView:s=>ce(s._id),onDelete:s=>ae(s._id),actions:!0,actionLabels:{view:"צפה בפרופיל",delete:"הסר מהשיעור"}}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(_,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"אין תלמידים רשומים"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"התחל על ידי הוספת התלמיד הראשון"}),e.jsxs("button",{onClick:()=>C(!0),className:"inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors",children:[e.jsx(W,{className:"w-4 h-4 ml-1"}),"הוסף תלמיד ראשון"]})]})]})})]}),Y&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsx("div",{className:"bg-white rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"רישום נוכחות"}),e.jsx("button",{onClick:()=>p(!1),className:"text-gray-400 hover:text-gray-600",children:e.jsx(E,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-900 mb-2",children:"תאריך השיעור"}),e.jsx("input",{type:"date",value:G,onChange:s=>H(s.target.value),className:"border border-gray-300 rounded-lg px-3 py-2"})]}),e.jsxs("div",{className:"mb-4 flex gap-2 flex-wrap",children:[e.jsxs("button",{onClick:le,className:"px-3 py-2 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors",children:[e.jsx(A,{className:"w-4 h-4 inline ml-1"}),"סמן הכל נוכח"]}),e.jsxs("button",{onClick:ie,className:"px-3 py-2 text-sm bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",children:[e.jsx(E,{className:"w-4 h-4 inline ml-1"}),"סמן הכל נעדר"]}),e.jsx("button",{onClick:oe,className:"px-3 py-2 text-sm bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors",children:"נקה הכל"})]}),e.jsx("div",{className:"space-y-3",children:o.map(s=>{const a=S.present.includes(s._id),l=S.absent.includes(s._id);return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:s.personalInfo?.fullName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["כיתה ",s.academicInfo?.class]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>F(s._id,!0),className:`px-3 py-1 text-sm rounded ${a?"bg-green-600 text-white":"bg-gray-200 text-gray-700 hover:bg-green-100"}`,children:"נכח"}),e.jsx("button",{onClick:()=>F(s._id,!1),className:`px-3 py-1 text-sm rounded ${l?"bg-red-600 text-white":"bg-gray-200 text-gray-700 hover:bg-red-100"}`,children:"נעדר"})]})]},s._id)})}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx("button",{onClick:ne,className:"flex-1 bg-primary-600 text-white py-2 rounded-lg hover:bg-primary-700 transition-colors",children:"שמור נוכחות"}),e.jsx("button",{onClick:()=>p(!1),className:"flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors",children:"ביטול"})]})]})})}),X&&e.jsx(ue,{theoryLesson:t,teachers:L,onSubmit:se,onCancel:()=>w(!1)}),x&&e.jsx(ye,{isOpen:J,title:x.title,message:x.message,onConfirm:Z,onCancel:ee,variant:x.variant})]})}export{Me as default};
