import{r as m}from"./vendor-C9PcmKF2.js";import{a as l}from"./cascade-deletion-BvQll6O-.js";import{t as d}from"./theoryEnrollmentService-CyV7tbhP.js";import{a as _,u as g,b as A}from"./query-BdHdBeoH.js";import"./utils-x1PSU_OZ.js";const c={STATIC_DATA_STALE_TIME:10*60*1e3,STATIC_DATA_CACHE_TIME:30*60*1e3,DYNAMIC_DATA_STALE_TIME:2*60*1e3,DYNAMIC_DATA_CACHE_TIME:5*60*1e3,REALTIME_DATA_STALE_TIME:30*1e3,REALTIME_DATA_CACHE_TIME:60*1e3},r={STUDENTS:["students"],STUDENT:e=>["student",e],STUDENT_THEORY_LESSONS:e=>["student",e,"theory-lessons"],STUDENT_ORCHESTRAS:e=>["student",e,"orchestras"],STUDENT_SCHEDULE:e=>["student",e,"schedule"],STUDENT_ATTENDANCE:e=>["student",e,"attendance"],STUDENT_DOCUMENTS:e=>["student",e,"documents"],TEACHERS:["teachers"],TEACHER:e=>["teacher",e],TEACHER_SCHEDULE:e=>["teacher",e,"schedule"],THEORY_LESSONS:["theory-lessons"],THEORY_LESSON:e=>["theory-lesson",e],ORCHESTRAS:["orchestras"],ORCHESTRA:e=>["orchestra",e],SCHOOL_YEARS:["school-years"],HOLIDAYS:["holidays"],INSTRUMENTS:["instruments"]},y=new Map;function T(e,t){if(y.has(e))return y.get(e);const u=t().finally(()=>{y.delete(e)});return y.set(e,u),u}const h={students:{getAll:()=>T("students-all",()=>l.students.getAllStudents()),getById:e=>T(`student-${e}`,()=>l.students.getStudentById(e)),update:(e,t)=>l.students.updateStudent(e,t)},teachers:{getAll:()=>T("teachers-all",()=>l.teachers.getAllTeachers()),getById:e=>T(`teacher-${e}`,()=>l.teachers.getTeacherById(e))},theoryLessons:{getAll:()=>T("theory-lessons-all",async()=>{const e=await l.theoryLessons.getTheoryLessons();return Array.isArray(e)?e:e?.data||[]}),getById:e=>T(`theory-lesson-${e}`,()=>l.theoryLessons.getTheoryLessonById(e)),addStudent:(e,t)=>d.enrollStudent(e,t,{method:"manual",performedBy:"teacher",reason:"Manual enrollment"}),removeStudent:(e,t)=>d.unenrollStudent(e,t,{reason:"Manual unenrollment"})},orchestras:{getAll:()=>T("orchestras-all",()=>l.orchestras.getAllOrchestras()),getById:e=>T(`orchestra-${e}`,()=>l.orchestras.getOrchestraById(e))},schoolData:{getSchoolYears:()=>T("school-years",()=>l.schoolData?.getSchoolYears?.()||Promise.resolve([])),getHolidays:()=>T("holidays",()=>l.schoolData?.getHolidays?.()||Promise.resolve([])),getInstruments:()=>T("instruments",()=>l.schoolData?.getInstruments?.()||Promise.resolve([]))}};function D(e){return _({queryKey:r.STUDENT(e||""),queryFn:()=>h.students.getById(e),enabled:!!e,staleTime:c.DYNAMIC_DATA_STALE_TIME,gcTime:c.DYNAMIC_DATA_CACHE_TIME,refetchOnWindowFocus:!1})}function L(){return _({queryKey:r.THEORY_LESSONS,queryFn:h.theoryLessons.getAll,staleTime:c.DYNAMIC_DATA_STALE_TIME,gcTime:c.DYNAMIC_DATA_CACHE_TIME,refetchOnWindowFocus:!1})}function M(e){const{data:t=[]}=L(),{data:u}=D(e);return m.useMemo(()=>{if(!e||!t.length)return[];const i=u?.enrollments?.theoryLessonIds||[];return t.filter(o=>o.studentIds?.includes(e)||i.includes(o._id))},[t,e,u?.enrollments?.theoryLessonIds])}function R(e,t,u){const{data:i=[]}=L(),{data:o}=D(e);return m.useMemo(()=>{if(!e||!i.length)return[];const S=o?.enrollments?.theoryLessonIds||[];return i.filter(s=>!(s.studentIds?.includes(e)||S.includes(s._id))).map(s=>{const n=s.maxStudents&&s.studentIds?.length>=s.maxStudents,a=!s.targetGrades||s.targetGrades.length===0||s.targetGrades.includes(t),E=!s.level||s.level===u||s.level==="all"||s.level==="mixed";return{...s,isCompatible:a&&E&&!n,gradeCompatible:a,levelCompatible:E,isFull:n,isEnrolled:!1}})},[i,e,o?.enrollments?.theoryLessonIds,t,u])}function f(e){const t=g(),u=A({mutationFn:({lessonId:o})=>h.theoryLessons.addStudent(o,e),onMutate:async({lessonId:o})=>{await t.cancelQueries({queryKey:r.THEORY_LESSONS}),await t.cancelQueries({queryKey:r.STUDENT(e)});const S=t.getQueryData(r.THEORY_LESSONS),s=t.getQueryData(r.STUDENT(e));return t.setQueryData(r.THEORY_LESSONS,n=>n?.map(a=>a._id===o?{...a,studentIds:[...a.studentIds||[],e]}:a)||[]),t.setQueryData(r.STUDENT(e),n=>n&&{...n,enrollments:{...n.enrollments,theoryLessonIds:[...n.enrollments?.theoryLessonIds||[],o]}}),{previousTheoryLessons:S,previousStudent:s}},onError:(o,S,s)=>{s?.previousTheoryLessons&&t.setQueryData(r.THEORY_LESSONS,s.previousTheoryLessons),s?.previousStudent&&t.setQueryData(r.STUDENT(e),s.previousStudent)},onSettled:()=>{t.invalidateQueries({queryKey:r.THEORY_LESSONS}),t.invalidateQueries({queryKey:r.STUDENT(e)})}}),i=A({mutationFn:({lessonId:o})=>h.theoryLessons.removeStudent(o,e),onMutate:async({lessonId:o})=>{await t.cancelQueries({queryKey:r.THEORY_LESSONS}),await t.cancelQueries({queryKey:r.STUDENT(e)});const S=t.getQueryData(r.THEORY_LESSONS),s=t.getQueryData(r.STUDENT(e));return t.setQueryData(r.THEORY_LESSONS,n=>n?.map(a=>a._id===o?{...a,studentIds:a.studentIds?.filter(E=>E!==e)||[]}:a)||[]),t.setQueryData(r.STUDENT(e),n=>n&&{...n,enrollments:{...n.enrollments,theoryLessonIds:n.enrollments?.theoryLessonIds?.filter(a=>a!==o)||[]}}),{previousTheoryLessons:S,previousStudent:s}},onError:(o,S,s)=>{s?.previousTheoryLessons&&t.setQueryData(r.THEORY_LESSONS,s.previousTheoryLessons),s?.previousStudent&&t.setQueryData(r.STUDENT(e),s.previousStudent)},onSettled:()=>{t.invalidateQueries({queryKey:r.THEORY_LESSONS}),t.invalidateQueries({queryKey:r.STUDENT(e)})}});return{enroll:u.mutate,unenroll:i.mutate,isEnrolling:u.isPending,isUnenrolling:i.isPending,error:u.error||i.error}}export{r as QUERY_KEYS,h as cachedApiService,R as useAvailableTheoryLessons,D as useStudent,M as useStudentTheoryLessons,f as useTheoryLessonEnrollment,L as useTheoryLessons};
